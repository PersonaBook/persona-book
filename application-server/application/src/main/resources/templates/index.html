<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <div class="container">
        <h1 class="my-4">PDF로 대화하기</h1>

        <div class="row row-cols-1 row-cols-md-3 g-4" id="pdf-items-container">
            <!-- "Add New PDF" Card -->
            <div class="col">
                <div class="card h-100 d-flex align-items-center justify-content-center" id="add-pdf-card" style="cursor: pointer; min-height: 250px;">
                    <div class="d-flex flex-column justify-content-center align-items-center" style="position: relative; width: 100%; height: 100%;">
                        <h1 style="font-size: 4rem; color: #6c757d;">+</h1>
                        <p class="text-muted">새로운 PDF 추가</p>
                        <input type="file" id="pdf-upload-input" accept=".pdf" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                    </div>
                </div>
            </div>
            <!-- PDF items will be dynamically added here -->
        </div>
    </div>
</div>

<script layout:fragment="script">
    document.addEventListener('DOMContentLoaded', function() {
        const pdfUploadInput = document.getElementById('pdf-upload-input');
        const pdfItemsContainer = document.getElementById('pdf-items-container');
        const addPdfCard = document.getElementById('add-pdf-card'); // Get the add-pdf-card element

        pdfUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);

                fetch('/api/pdf/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        console.log(data.message);
                        // Extract filename from the message. Assuming format: "Uploaded the file successfully: filename.pdf, URL: ..."
                        const filenameMatch = data.message.match(/filename:\s*([^,]+)/);
                        const filename = filenameMatch ? filenameMatch[1].trim() : file.name; // Fallback to original file name

                        // Simulate PDF item creation
                        const newPdfItem = document.createElement('div');
                        newPdfItem.classList.add('col');
                        newPdfItem.innerHTML = `
                            <div class="card h-100">
                                <img src="/image/pdf-상세.png" class="card-img-top" alt="PDF Thumbnail">
                                <div class="card-body">
                                    <h5 class="card-title">${file.name}</h5>
                                    <p class="card-text">업로드 날짜: ${new Date().toLocaleDateString()}</p>
                                    <a href="/api/pdf/view/${filename}" class="btn btn-outline-primary" target="_blank">대화하기</a>
                                </div>
                            </div>
                        `;
                        
                        // Insert the new PDF item before the "Add New PDF" card
                        pdfItemsContainer.insertBefore(newPdfItem, addPdfCard.parentNode);

                        // Clear the input so the same file can be selected again
                        pdfUploadInput.value = '';
                    } else {
                        console.error('Upload failed:', data);
                        alert('PDF 업로드에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error during PDF upload:', error);
                    alert('PDF 업로드 중 오류가 발생했습니다.');
                });
            }
        });
    });
</script>

</html>